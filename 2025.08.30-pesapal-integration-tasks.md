# Pesapal Payment Gateway Integration - Implementation Roadmap

**Date:** August 30, 2025  
**Project:** BlitXpress E-commerce Platform  
**Payment Gateway:** Pesapal API 3.0 (REST JSON)

## 📋 Executive Summary

Pesapal is a leading payment gateway in East Africa (Kenya, Uganda, Tanzania, etc.) that supports multiple payment methods including mobile money (M-Pesa, Airtel Money, MTN Mobile Money), bank cards, and bank transfers. We will integrate Pesapal API 3.0 (REST/JSON) into our BlitXpress multi-platform system.

## 🔧 Technical Overview

### API Details
- **API Version:** 3.0 (REST with JSON data format)
- **Base URLs:**
  - **Sandbox:** `https://cybqa.pesapal.com/pesapalv3`
  - **Production:** `https://pay.pesapal.com/v3`
- **Authentication:** Bearer token (expires every 5 minutes)
- **Documentation:** https://developer.pesapal.com/how-to-integrate/e-commerce/api-30-json/api-reference
- **Postman Collection:** https://documenter.getpostman.com/view/6715320/UyxepTv1

### Your Credentials

⚠️ **SECURITY NOTE:** Your live Pesapal credentials are stored securely in the `.env` file and should NEVER be included in documentation or version control.

**Configuration Location:** `/Applications/MAMP/htdocs/blitxpress/.env`
- `PESAPAL_CONSUMER_KEY` - Your live consumer key
- `PESAPAL_CONSUMER_SECRET` - Your live consumer secret

### Test Credentials (for development)

For sandbox testing, you can use these public test credentials:
- **Kenyan Merchant Test:**
  - Consumer Key: `qkio1BGGYAXTu2JOfm7XSXNruoZsrqEW`
  - Consumer Secret: `osGQ364R49cXKeOYSpaOnT++rHs=`

## 🏗️ System Architecture & Workflow

```
Customer Order Submission Flow:

1. Customer completes checkout (products + delivery info)
   ↓
2. Laravel creates order in database (status: PENDING_PAYMENT)
   ↓
3. React/Flutter initiates payment for existing order
   ↓
4. Laravel Backend calls Pesapal API for payment processing
   ↓
5. Pesapal returns payment URL for customer
   ↓
6. Customer completes payment on Pesapal platform
   ↓
7. Pesapal sends IPN notification to Laravel
   ↓
8. Laravel updates order status (PAID/FAILED)
```

**Platform Integration:**
```
React Frontend ──► Laravel Backend API ──► Pesapal API 3.0
       │                    │                      │
   Checkout UI         Order Management      Payment Processing
       │                    │                      │
Flutter Mobile ──────────────┼──────────────────────┤
       │                    │                      │
   Mobile Pay          Transaction Status    IPN Notifications
```

## 📝 Implementation Tasks

### Phase 1: Backend Integration (Laravel)

#### [ ] Task 1.1: Environment Configuration
- [ ] Add Pesapal credentials to `.env` file
- [ ] Create Pesapal configuration file
- [ ] Set up sandbox/production environment switching

```env
# Add to .env (use your actual credentials from Pesapal dashboard)
PESAPAL_CONSUMER_KEY=your_live_consumer_key_here
PESAPAL_CONSUMER_SECRET=your_live_consumer_secret_here
PESAPAL_ENVIRONMENT=sandbox # or production
PESAPAL_SANDBOX_URL=https://cybqa.pesapal.com/pesapalv3
PESAPAL_PRODUCTION_URL=https://pay.pesapal.com/v3
PESAPAL_IPN_URL=https://blit.blitxpress.com/api/pesapal/ipn
PESAPAL_CALLBACK_URL=https://blit.blitxpress.com/payment-callback
```

#### [ ] Task 1.2: Database Schema Updates
- [ ] Create `pesapal_transactions` table
- [ ] Create `pesapal_ipn_logs` table  
- [ ] Add payment gateway fields to existing `orders` table

```sql
-- pesapal_transactions
id, order_id, order_tracking_id, merchant_reference, 
amount, currency, status, payment_method, confirmation_code,
payment_account, created_at, updated_at

-- pesapal_ipn_logs
id, order_tracking_id, merchant_reference, notification_type,
payload, processed_at, status, created_at
```

#### [ ] Task 1.3: Pesapal Service Class
- [ ] Create `PesapalService` class with authentication
- [ ] Implement token management (auto-refresh every 5 minutes)
- [ ] Add methods for all API endpoints:
  - `authenticate()` - Get bearer token
  - `registerIpnUrl()` - Register IPN endpoint
  - `submitOrderRequest()` - Create payment request
  - `getTransactionStatus()` - Check payment status

#### [ ] Task 1.4: API Routes and Controllers
- [ ] Create `PesapalController` 
- [ ] Add routes for:
  - `POST /api/pesapal/initialize` - Start payment process
  - `GET /api/pesapal/callback` - Handle payment callback
  - `POST /api/pesapal/ipn` - Handle IPN notifications
  - `GET /api/pesapal/status/{orderId}` - Check payment status

#### [ ] Task 1.5: Order Integration

- [ ] **CRITICAL:** Ensure orders are created BEFORE payment processing
- [ ] Modify existing `ApiResurceController@orders` method to:
  - Create order with status "PENDING_PAYMENT"
  - Generate unique merchant_reference (order_id)
  - Store order details before calling Pesapal
- [ ] Add new payment endpoint: `POST /api/orders/{orderId}/pay`
- [ ] Add payment retry functionality for existing unpaid orders
- [ ] Update order status based on payment results (PAID/FAILED/CANCELLED)
- [ ] Handle failed/cancelled payments (keep order, allow retry)

### Phase 2: Frontend Integration (React)

#### [ ] Task 2.1: Payment Components
- [ ] Create `PesapalPayment.tsx` component
- [ ] Add Pesapal option to checkout payment methods
- [ ] Create payment iframe integration
- [ ] Handle payment redirects and callbacks

#### [ ] Task 2.2: API Integration
- [ ] Update `realProductsApi.ts` with Pesapal endpoints
- [ ] Add payment initialization API call
- [ ] Add payment status checking
- [ ] Handle payment success/failure states

#### [ ] Task 2.3: UI/UX Components
- [ ] Payment method selection UI
- [ ] Payment processing loader/spinner
- [ ] Payment success/failure pages
- [ ] Order confirmation with payment details

#### [ ] Task 2.4: State Management
- [ ] Add payment-related Redux slices
- [ ] Manage payment flow state
- [ ] Handle payment session data
- [ ] Update cart/order state after payment

### Phase 3: Mobile Integration (Flutter)

#### [ ] Task 3.1: Mobile Payment Service
- [ ] Add Pesapal endpoints to `Utils.dart`
- [ ] Create mobile payment flow
- [ ] Handle WebView for payment redirect
- [ ] Implement payment status checking

#### [ ] Task 3.2: UI Integration
- [ ] Add Pesapal to mobile checkout screen
- [ ] Payment method selection UI
- [ ] WebView payment interface
- [ ] Success/failure screens

### Phase 4: Testing and Validation

#### [ ] Task 4.1: Sandbox Testing
- [ ] Test authentication and token generation
- [ ] Test IPN URL registration
- [ ] Test order submission and payment flow
- [ ] Test various payment methods (M-Pesa, Cards, etc.)
- [ ] Test callback and IPN handling

#### [ ] Task 4.2: Error Handling
- [ ] Handle network timeouts
- [ ] Handle invalid credentials
- [ ] Handle payment failures
- [ ] Handle duplicate transactions
- [ ] Implement proper logging

#### [ ] Task 4.3: Security Implementation
- [ ] Validate IPN signatures
- [ ] Implement HTTPS enforcement
- [ ] Sanitize callback parameters
- [ ] Add CSRF protection
- [ ] Implement rate limiting

### Phase 5: Production Deployment

#### [ ] Task 5.1: Production Setup
- [ ] Switch to production credentials
- [ ] Update environment variables
- [ ] Register production IPN URLs
- [ ] SSL certificate verification

#### [ ] Task 5.2: Monitoring and Logging
- [ ] Set up payment transaction logging
- [ ] Implement error monitoring
- [ ] Create payment analytics dashboard
- [ ] Set up alerts for failed payments

## ⚠️ **IMPORTANT WORKFLOW RULE**

**Payment Processing Order:**
1. **FIRST:** Customer completes order submission (products, delivery details, customer info)
2. **SECOND:** Order is created in database with "PENDING_PAYMENT" status
3. **THIRD:** Payment gateway (Pesapal) is initiated for the created order
4. **FOURTH:** Payment completion updates the order status to "PAID" or "FAILED"

**Key Points:**
- Orders must exist in database BEFORE payment processing begins
- Each order gets a unique `order_id` that links to the payment transaction
- Payment is for an existing order, not for creating a new order
- Failed payments do not delete the order - they remain as "PENDING_PAYMENT"
- Customers can retry payment for existing unpaid orders

## 🔄 Integration Flow

### 1. Authentication Flow
```php
// Get Bearer Token (expires in 5 minutes)
POST /api/Auth/RequestToken
{
    "consumer_key": "your_key",
    "consumer_secret": "your_secret"
}
```

### 2. IPN Registration
```php
// Register notification URL
POST /api/URLSetup/RegisterIPN
{
    "url": "https://yourdomain.com/api/pesapal/ipn",
    "ipn_notification_type": "POST"
}
```

### 3. Payment Request
```php
// Submit Order Request
POST /api/Transactions/SubmitOrderRequest
{
    "id": "unique_merchant_ref",
    "currency": "UGX",
    "amount": 50000.00,
    "description": "Order payment",
    "callback_url": "https://yourdomain.com/payment-success",
    "notification_id": "ipn_id_from_step_2",
    "billing_address": {...}
}
```

### 4. Status Verification
```php
// Check Transaction Status
GET /api/Transactions/GetTransactionStatus?orderTrackingId=xxx
```

## 📊 Payment Methods Supported
- **Mobile Money:** M-Pesa, Airtel Money, MTN Mobile Money
- **Bank Cards:** Visa, Mastercard, Amex
- **Bank Transfers:** Various East African banks
- **Digital Wallets:** PayPal, etc.

## 🔐 Security Considerations

- [ ] Implement proper token refresh mechanism
- [ ] Validate all IPN notifications
- [ ] Use HTTPS for all API calls
- [ ] Implement proper error logging
- [ ] Add request/response encryption where needed
- [ ] Implement duplicate transaction prevention

## 📋 Testing Checklist

### Functional Testing
- [ ] Token generation and refresh
- [ ] Order creation and submission  
- [ ] Payment success flow
- [ ] Payment failure handling
- [ ] IPN notification handling
- [ ] Status checking and updates

### Integration Testing
- [ ] Frontend payment flow
- [ ] Mobile payment process
- [ ] Backend API integration
- [ ] Database transaction updates
- [ ] Email notifications
- [ ] Order status synchronization

### Security Testing
- [ ] IPN validation
- [ ] CSRF protection
- [ ] SSL certificate verification
- [ ] Input sanitization
- [ ] Authentication security
- [ ] Rate limiting

## 📈 Success Metrics

- [ ] Successful payment completion rate > 95%
- [ ] IPN notification processing < 2 seconds
- [ ] Payment status sync accuracy 100%
- [ ] Zero duplicate transactions
- [ ] Proper error handling and recovery
- [ ] Customer payment experience satisfaction

## 🚀 Deployment Schedule

**Week 1:** Backend implementation (Tasks 1.1-1.5)  
**Week 2:** Frontend integration (Tasks 2.1-2.4)  
**Week 3:** Mobile integration (Tasks 3.1-3.2)  
**Week 4:** Testing and validation (Tasks 4.1-4.3)  
**Week 5:** Production deployment (Tasks 5.1-5.2)

## 📞 Support and Resources

- **Pesapal Documentation:** https://developer.pesapal.com
- **Developer Forum:** https://developer.pesapal.com/forum
- **Sample Code:** https://github.com/Pesapal-Ltd/sample_api3
- **Support Email:** [Contact via website](https://www.pesapal.com/help-support)
- **Postman Collection:** https://documenter.getpostman.com/view/6715320/UyxepTv1

---

**Note:** This roadmap covers complete integration across Laravel backend, React frontend, and Flutter mobile app. Each task should be completed in sequence to ensure proper functionality and testing.
